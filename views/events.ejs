<%- include('partials/header') %>
    <%- include('partials/nav') %>
        <%- include('partials/aesthetic-bg') %>

            <div class="container section" style="margin-top: 4rem;">
                <h1>Available Events</h1>
                <p style="margin-bottom: 2rem;">Browse and register for upcoming events.</p>

                <!-- Search and Filter Form -->
                <form action="/events" method="GET" style="margin-bottom: 2rem;">
                    <div style="display: flex; flex-direction: column; gap: 1rem; max-width: 100%;">
                        <div class="aesthetic-search" style="max-width: 100%;">
                            <input type="text" name="search" placeholder="Search by title..."
                                value="<%= typeof search !== 'undefined' ? search : '' %>">
                            <button type="submit">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                                </svg>
                            </button>
                        </div>

                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div style="position: relative;">
                                <select name="type" onchange="this.form.submit()"
                                    style="appearance: none; -webkit-appearance: none; padding: 0.8rem 2.5rem 0.8rem 1.5rem; border: 1px solid var(--border-color); border-radius: 50px; background-color: white; font-size: 0.95rem; cursor: pointer; outline: none; min-width: 200px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);">
                                    <option value="">All Event Types</option>
                                    <% if (typeof eventTypes !=='undefined' && eventTypes.length> 0) { %>
                                        <% eventTypes.forEach(t=> { %>
                                            <option value="<%= t %>" <%=typeof type !=='undefined' && type===t
                                                ? 'selected' : '' %>><%= t %>
                                            </option>
                                            <% }) %>
                                                <% } %>
                                </select>
                                <div
                                    style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-secondary);">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                        stroke-width="2" stroke="currentColor" style="width: 16px; height: 16px;">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </div>
                            </div>

                            <% if ((typeof search !=='undefined' && search) || (typeof type !=='undefined' && type)) {
                                %>
                                <a href="/events" class="btn btn-outline"
                                    style="padding: 0.5rem 1rem; text-decoration: none; border-radius: 50px;">Clear
                                    Filters</a>
                                <% } %>
                        </div>
                    </div>
                </form>

                <% if (events.length===0 && !search && !type) { %>
                    <p>No upcoming events found.</p>
                    <% } else if (events.length===0) { %>
                        <p>No events match your search/filter.</p>
                        <% } else { %>
                            <div class="card-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem;">
                                <% events.forEach(event=> { %>
                                    <div class="card"
                                        style="display: flex; flex-direction: column; height: 100%; background-color: rgba(255, 255, 255, 0.6);">
                                        <div class="card-body" style="flex: 1;">
                                            <h3 style="margin-top: 0;">
                                                <%= event.eventname %>
                                            </h3>
                                            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                                                <strong>Date:</strong>
                                                <%= new Date(event.eventdatetimestart).toLocaleString() %><br>
                                                    <strong>Location:</strong>
                                                    <%= event.eventlocation %>
                                            </p>
                                            <p>
                                                <%= event.eventdescription %>
                                            </p>
                                        </div>
                                        <div class="card-footer"
                                            style="margin-top: auto; padding-top: 1rem; border-top: 1px solid #eee;">
                                            <% if (user && user.role==='Manager' ) { %>
                                                <a href="/events/<%= event.eventoccurrenceid %>/participants"
                                                    class="btn btn-primary"
                                                    style="width: 100%; text-align: center;">Registered Participants</a>
                                                <% } else if (registeredEventIds.includes(event.eventoccurrenceid)) { %>
                                                    <button class="btn btn-outline" disabled
                                                        style="width: 100%; cursor: default; opacity: 0.7;">Registered</button>
                                                    <% } else if (participant) { %>
                                                        <form action="/events/register/<%= event.eventoccurrenceid %>"
                                                            method="POST">
                                                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                            <button type="submit" class="btn btn-primary"
                                                                style="width: 100%;">Register</button>
                                                        </form>
                                                        <% } else { %>
                                                            <a href="/register" class="btn btn-primary"
                                                                style="width: 100%; text-align: center;">Register
                                                                (Requires
                                                                Participant Account)</a>
                                                            <% } %>
                                        </div>
                                    </div>
                                    <% }) %>
                            </div>
                            <% } %>
            </div>

            <%- include('partials/footer') %>